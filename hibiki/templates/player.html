{% extends "Sidebar.html" %}
{% block content %}
{{ tracks|json_script:"tracks-data" }}

<style>
  body{
    overflow: hidden;
  }
/* Container with background */
.player-container {
  position: relative;
  width: 100%;
  height: 100vh;
  /* overflow: hidden; */
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  color: white;
}

/* Dynamic background image */
.player-background {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  filter: brightness(0.6) blur(8px);
  z-index: -1;
}

/* Foreground info */
.song-info {
  text-align: center;
  margin-bottom: 0px;
}
.song-info h2 {
  font-size: 28px;
  font-weight: bold;
  margin: 0 0 8px;
}
.song-info p {
  font-size: 16px;
  color: #ccc;
  margin: 0;
}

/* Player footer */
.player-footer {
    width: 100%;
    max-width: 600px;
    padding: 50px;
}
.progress-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 15px;
}
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 5px;
  background: rgba(255,255,255,0.4);
  border-radius: 5px;
  outline: none;
  margin-bottom: 6px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #1db954;
  border-radius: 50%;
  cursor: pointer;
}
.time-stamps {
  width: 100%;
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #eee;
}
.controls {
  display: flex;
  justify-content: center;
  gap: 35px;
  margin-top: 10px;
}
.controls button {
  background: none;
  border: none;
  font-size: 32px;
  cursor: pointer;
  color: white;
  transition: transform 0.2s, color 0.2s;
}
.controls button:hover {
  transform: scale(1.2);
  color: #1db954;
}

/* Drawer Playlist */
.drawer {
  position: fixed;
  top: 0;
  right: -400px;
  width: 350px;
  height: 100%;
  background: #111;
  color: white;
  box-shadow: -4px 0 20px rgba(0,0,0,0.5);
  transition: right 0.3s ease;
  z-index: 1000;
  padding: 20px;
  display: flex;
  flex-direction: column;
}
.drawer.open { right: 0; }
.drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.drawer h3 { font-size: 18px; margin: 0; }
.drawer-close {
  background: none;
  border: none;
  font-size: 24px;
  color: white;
  cursor: pointer;
}
.playlist {
  list-style: none;
  padding: 0;
  margin-top: 20px;
  overflow-y: auto;
  flex: 1;
}
.playlist li {
  display: flex;
  align-items: center;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.playlist li:hover { background: rgba(255,255,255,0.1); }
.playlist img {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  margin-right: 12px;
}
.playlist .track-info { flex: 1; }
.playlist .track-info h4 { margin: 0; font-size: 14px; }
.playlist .track-info p { margin: 0; font-size: 12px; color: #aaa; }

/* Playlist toggle button */
#playlist-toggle {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #1db954;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  color: white;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
</style>

<div class="player-container">
  <!-- Background -->
  <div class="player-background" id="player-bg"></div>

  <!-- Toggle Playlist Drawer -->
  <button id="playlist-toggle">≡</button>

  <!-- Song Info -->
  <div class="song-info">
    <h2 id="track-title">{{ firstTrack.title }}</h2>
    <p id="track-artists">
      {% for artist in firstTrack.artists %}
        {{ artist.name }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
  </div>

  <!-- Footer Controls -->
  <div class="player-footer">
    <div class="progress-container">
      <input type="range" id="progress" value="0" min="0" max="100">
      <div class="time-stamps">
        <span id="current-time">0:00</span>
        <span id="duration">0:00</span>
      </div>
    </div>

    <div class="controls">
      <button id="prev">⏮</button>
      <button id="play">▶</button>
      <button id="next">⏭</button>
    </div>
  </div>

  <!-- Playlist Drawer -->
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <h3>Playlist</h3>
      <button class="drawer-close" id="drawer-close">&times;</button>
    </div>
    <ul class="playlist" id="playlist">
      {% for track in tracks %}
      <li data-index="{{ forloop.counter0 }}">
        <img src="{{ track.thumbnails.0.url }}" alt="">
        <div class="track-info">
          <h4>{{ track.title }}</h4>
          <p>
            {% for artist in track.artists %}
              {{ artist.name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </p>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>

  <audio id="audio"></audio>
</div>

<script>
const tracks = JSON.parse(document.getElementById("tracks-data").textContent);
let currentIndex = 0;

const audio = document.getElementById("audio");
const playBtn = document.getElementById("play");
const progress = document.getElementById("progress");
const currentTimeEl = document.getElementById("current-time");
const durationEl = document.getElementById("duration");

const titleEl = document.getElementById("track-title");
const artistEl = document.getElementById("track-artists");
const bgEl = document.getElementById("player-bg");

// Drawer elements
const drawer = document.getElementById("drawer");
document.getElementById("playlist-toggle").addEventListener("click", () => {
  drawer.classList.add("open");
});
document.getElementById("drawer-close").addEventListener("click", () => {
  drawer.classList.remove("open");
});

function formatTime(time) {
  let minutes = Math.floor(time / 60);
  let seconds = Math.floor(time % 60).toString().padStart(2, "0");
  return `${minutes}:${seconds}`;
}
function loadTrack(index, autoplay = false) {
  const track = tracks[index];
  if (!track) return;

  audio.pause();
  audio.currentTime = 0;
  playBtn.textContent = "▶";

  currentIndex = index;
  titleEl.textContent = track.title;
  artistEl.textContent = track.artists.map(a => a.name).join(", ");
  bgEl.style.backgroundImage = `url(${track.thumbnails[0].url})`;

  fetch(`/get_audio_url?video_id=${track.videoId}`)
    .then(res => res.json())
    .then(data => {
      if (data.audio_url) {
        audio.src = data.audio_url;
        if (autoplay) {
          audio.play().then(() => {
            playBtn.textContent = "⏸";
          }).catch(() => {
            // Autoplay blocked
            playBtn.textContent = "▶";
          });
        }
      }
    });
}


playBtn.addEventListener("click", () => {
  if (audio.paused) {
    audio.play();
    playBtn.textContent = "⏸";
  } else {
    audio.pause();
    playBtn.textContent = "▶";
  }
});

document.getElementById("next").addEventListener("click", () => {
  currentIndex = (currentIndex + 1) % tracks.length;
  loadTrack(currentIndex);
});
document.getElementById("prev").addEventListener("click", () => {
  currentIndex = (currentIndex - 1 + tracks.length) % tracks.length;
  loadTrack(currentIndex);
});

audio.addEventListener("timeupdate", () => {
  if (!isNaN(audio.duration)) {
    progress.value = (audio.currentTime / audio.duration) * 100;
  }
  currentTimeEl.textContent = formatTime(audio.currentTime);
});

audio.addEventListener("ended", () => {
  currentIndex = (currentIndex + 1) % tracks.length;
  loadTrack(currentIndex);
});

audio.addEventListener("loadedmetadata", () => {
  durationEl.textContent = formatTime(audio.duration);
});

progress.addEventListener("input", e => {
  audio.currentTime = (e.target.value / 100) * audio.duration;
});

document.getElementById("playlist").addEventListener("click", (e) => {
  const li = e.target.closest("li");
  if (li) {
    const index = parseInt(li.dataset.index);
    loadTrack(index);
    drawer.classList.remove("open");
  }
});

loadTrack(currentIndex, true);

</script>
{% endblock %}
