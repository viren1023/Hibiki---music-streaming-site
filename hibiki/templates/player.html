{% extends "Sidebar.html" %}
{% block content %}
{{ tracks|json_script:"tracks-data" }}

<style>


.player-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px 20px;
  box-sizing: border-box;
}

/* Song card */
.song-card {
  background: linear-gradient(145deg, #1a1a1a, #222);
  border-radius: 20px;
  padding: 25px;
  text-align: center;
  max-width: 350px;
  width: 100%;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  margin-bottom: 30px;
}
.song-card img {
  width: 100%;
  border-radius: 15px;
  margin-bottom: 15px;
}
.song-card h2 {
  font-size: 20px;
  margin: 10px 0 5px;
  font-weight: bold;
}
.song-card p {
  font-size: 14px;
  color: #bbb;
  margin: 0;
}

/* Player footer */
.player-footer {
  width: 100%;
  max-width: 400px;
  margin-bottom: 30px;
}
.progress-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 15px;
}
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 5px;
  background: #444;
  border-radius: 5px;
  outline: none;
  margin-bottom: 6px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #1db954;
  border-radius: 50%;
  cursor: pointer;
}
.time-stamps {
  width: 100%;
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #aaa;
}
.controls {
  display: flex;
  justify-content: center;
  gap: 25px;
}
.controls button {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: white;
  transition: transform 0.2s;
}
.controls button:hover {
  transform: scale(1.2);
  color: #1db954;
}

/* Playlist section */
.playlist-section {
  width: 100%;
  max-width: 500px;
  margin-top: 20px;
}
.playlist-section h3 {
  font-size: 18px;
  margin-bottom: 15px;
}
.playlist {
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 300px;
  overflow-y: auto;
}
.playlist li {
  display: flex;
  align-items: center;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.playlist li:hover {
  background: rgba(255,255,255,0.1);
}
.playlist img {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  margin-right: 12px;
}
.playlist .track-info {
  flex: 1;
}
.playlist .track-info h4 {
  margin: 0;
  font-size: 14px;
}
.playlist .track-info p {
  margin: 0;
  font-size: 12px;
  color: #aaa;
}
</style>

<div class="player-container">
  <!-- Song Info Card -->
  <div class="song-card">
    <img id="track-thumb" src="{{ firstTrack.thumbnails.1.url }}" alt="">
    <h2 id="track-title">{{ firstTrack.title }}</h2>
    <p id="track-artists">
      {% for artist in firstTrack.artists %}
        {{ artist.name }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
  </div>

  <!-- Footer Controls -->
  <div class="player-footer">
    <div class="progress-container">
      <input type="range" id="progress" value="0" min="0" max="100">
      <div class="time-stamps">
        <span id="current-time">0:00</span>
        <span id="duration">0:00</span>
      </div>
    </div>

    <div class="controls">
      <button id="prev">⏮</button>
      <button id="play">▶</button>
      <button id="next">⏭</button>
    </div>
  </div>

  <!-- Playlist Section -->
  <div class="playlist-section">
    <h3>Playlist</h3>
    <ul class="playlist" id="playlist">
      {% for track in tracks %}
      <li data-index="{{ forloop.counter0 }}">
        <img src="{{ track.thumbnails.1.url }}" alt="">
        <div class="track-info">
          <h4>{{ track.title }}</h4>
          <p>
            {% for artist in track.artists %}
              {{ artist.name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </p>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>

  <audio id="audio"></audio>
</div>

<script>
const tracks = JSON.parse(document.getElementById("tracks-data").textContent);
let currentIndex = 0;

const audio = document.getElementById("audio");
const playBtn = document.getElementById("play");
const progress = document.getElementById("progress");
const currentTimeEl = document.getElementById("current-time");
const durationEl = document.getElementById("duration");

const titleEl = document.getElementById("track-title");
const artistEl = document.getElementById("track-artists");
const thumbEl = document.getElementById("track-thumb");

function formatTime(time) {
  let minutes = Math.floor(time / 60);
  let seconds = Math.floor(time % 60).toString().padStart(2, "0");
  return `${minutes}:${seconds}`;
}

function loadTrack(index) {
  const track = tracks[index];
  if (!track) return;

  // Stop and reset any current playback
  audio.pause();
  audio.currentTime = 0;
  playBtn.textContent = "▶";

  currentIndex = index;
  titleEl.textContent = track.title;
  artistEl.textContent = track.artists.map(a => a.name).join(", ");
  thumbEl.src = track.thumbnails[0].url;

  fetch(`/get_audio_url?video_id=${track.videoId}`)
    .then(res => res.json())
    .then(data => {
      if (data.audio_url) {
        audio.src = data.audio_url;
        audio.play();
        playBtn.textContent = "⏸";
      }
    });
}


playBtn.addEventListener("click", () => {
  if (audio.paused) {
    audio.play();
    playBtn.textContent = "⏸";
  } else {
    audio.pause();
    playBtn.textContent = "▶";
  }
});

document.getElementById("next").addEventListener("click", () => {
  currentIndex = (currentIndex + 1) % tracks.length;
  loadTrack(currentIndex);
});
document.getElementById("prev").addEventListener("click", () => {
  currentIndex = (currentIndex - 1 + tracks.length) % tracks.length;
  loadTrack(currentIndex);
});

audio.addEventListener("timeupdate", () => {
  if (!isNaN(audio.duration)) {
    progress.value = (audio.currentTime / audio.duration) * 100;
  }
  currentTimeEl.textContent = formatTime(audio.currentTime);
});

audio.addEventListener("ended", () => {
  currentIndex = (currentIndex + 1) % tracks.length; // loop back if at end
  loadTrack(currentIndex);
  audio.play(); // start playing automatically
});

audio.addEventListener("loadedmetadata", () => {
  durationEl.textContent = formatTime(audio.duration);
});

progress.addEventListener("input", e => {
  audio.currentTime = (e.target.value / 100) * audio.duration;
});

// Playlist click event
document.getElementById("playlist").addEventListener("click", (e) => {
  const li = e.target.closest("li");
  if (li) {
    const index = parseInt(li.dataset.index);
    loadTrack(index);
  }
});

// Load first track
loadTrack(currentIndex);
</script>
{% endblock %}
